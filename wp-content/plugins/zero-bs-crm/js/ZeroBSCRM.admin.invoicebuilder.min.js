var zbs_invoice=!1,zbs_tax=!1,zbs_tax_table=!1,zbsInvBlocker=!1;function zbscrm_JS_retrieve_invoice_data(i){i={action:"zbs_get_invoice_data",sec:window.zbscrmjs_secToken,invid:i};jQuery.ajax({type:"POST",url:ajaxurl,data:i,dataType:"json",timeout:2e4,success:function(i){void 0!==i&&(window.zbs_invoice=i),void 0!==i.tax_linesObj&&(window.zbs_tax_table=i.tax_linesObj),void 0!==i.invoiceObj&&void 0!==i.invoiceObj.settings&&void 0!==i.invoiceObj.settings.invtax&&(window.zbs_tax=i.invoiceObj.settings.invtax),zbscrm_JS_draw_invoice_html()},error:function(i){jQuery("#zbsCantLoadDataSingle").show(),jQuery("#zbs-edit-wrap, #zbs-screen-options").hide(),jQuery("#zbs_loader, #zbs_invoice").hide()}})}function zbscrm_JS_draw_invoice_html(){var i;void 0!==window.zbs_invoice&&!1!==window.zbs_invoice?(jQuery("#zbsCantLoadDataSingle").hide(),jQuery("#zbs-edit-wrap, #zbs-screen-options").show(),jQuery("#zbs_loader, #zbs_invoice").show(),i="",i=zbscrm_JS_draw_invoice_actions_html(window.zbs_invoice),i=(i=(i=(i=(i=(i=(i=(i=(i+='<div id="zbs_top_wrapper">')+zbscrm_JS_draw_invoice_logo_html(window.zbs_invoice))+zbscrm_JS_draw_invoice_top_right_form(window.zbs_invoice)+'</div><div style="clear:both">&nbsp;</div><div id="zbs_sub_wrapper" class="ui grid"><div class="six wide column">')+zbscrm_JS_draw_invoice_biz_info(window.zbs_invoice)+'</div><div class="ten wide column">')+zbscrm_JS_draw_send_invoice_to(window.zbs_invoice)+"</div></div>")+zbscrm_JS_draw_customise(window.zbs_invoice))+zbscrm_JS_draw_line_items(window.zbs_invoice))+zbscrm_JS_draw_invoice_totals(window.zbs_invoice))+zbscrm_JS_draw_partials_table(window.zbs_invoice),jQuery(".zbs_invoice_html_canvas").html(i),setTimeout(function(){jQuery("#zbs-invoice-custom-fields-holder table tr").appendTo(".zbs-invoice-topper table"),zbscrm_JS_bind_row_actions(),zbscrm_JS_bind_change_actions(),zbscrm_JS_bind_invoice_actions(),jQuery("#zbs_loader").hide()},0)):(jQuery("#zbsCantLoadDataSingle").show(),jQuery("#zbs-edit-wrap, #zbs-screen-options").hide(),jQuery("#zbs_loader, #zbs_invoice").hide())}function zbscrm_JS_draw_invoice_actions_html(i){var e;return html=(html=(html="")+'<div id="zbs_invoice_actions">'+'<div class="zbs-invoice-status">')+('<span class="'+i.invoiceObj.status+' statty">'+i.invoiceObj.status+"</span>")+"</div>",i.invoiceObj.new_invoice||(i.invoiceObj.portal_installed&&(html+='<a href="'+i.invoiceObj.preview_link+'" target="_blank" class="ui button blue" id="zbs_invoice_preview">'+zbscrm_JS_invoice_lang("preview")+"</a>"),i.invoiceObj.pdf_installed&&(html+='<button id="zbs_invoicing_download_pdf" type="button" class="ui button olive">'+zbscrm_JS_invoice_lang("dl_pdf")+"</button>",Formhtml='<form target="_blank" method="post" id="zbs_invoicing_download_pdf_form" action="">',Formhtml=(Formhtml+='<input type="hidden" name="zbs_invoicing_download_pdf" value="1" />')+'<input type="hidden" name="zbs_invoice_id" value="'+i.invoiceObj.id+'" /></form>',jQuery("#wpbody").append(Formhtml)),void 0!==window.zbsJS_invEmailActive&&1==window.zbsJS_invEmailActive&&void 0!==(e=zbscrmJS_retrieveCurrentBillToEmail())&&""!=e&&zbscrm_JS_validateEmail(e)&&(html+='<button type="button" id="zbs_invoicing_send_email" class="ui button yellow">'+zbscrm_JS_invoice_lang("send_email")+"</button>")),i.invoiceObj.new_invoice&&(html+='<input type="hidden" name="zbscrm_newinvoice" value="1" />'),html+="</div>"}function zbscrmJS_retrieveCurrentBillToEmail(){var i,e=jQuery("#zbs_inv_bill").val();return e=void 0!==e&&zbscrm_JS_validateEmail(e)?e:i=null!=(i=window.zbs_invoice.invoiceObj.bill)&&""!=i||void 0===window.zbsJS_prefillemail||void 0===window.zbsJS_prefillid?i:window.zbsJS_prefillemail}function zbscrm_JS_draw_invoice_logo_html(i){var e,n="",t="";return""!=i.invoiceObj.logo_url&&(n="hide",t="show"),e='<div id="zbs_invoice_logos">',(e+='<div class="wh-logo '+n+'">')+('<i class="fa fa-file-image-o" aria-hidden="true"></i><span class="wh-logo-text">+ '+zbscrm_JS_invoice_lang("add_logo")+"</span>")+"</div>"+('<div class="wh-logo-set '+t+'">')+('<img id="wh-logo-set-img" src="'+i.invoiceObj.logo_url+'" />')+('<input type="hidden" name="zbsi_logo" id="logo" value="'+i.invoiceObj.logo_url+'" />')+'<div class="zbs-logo-options">'+('<span class="zbs-update">'+zbscrm_JS_invoice_lang("update")+"</span>")+('<span class="zbs-remove"> '+zbscrm_JS_invoice_lang("remove")+"</span>")+"</div>"+"</div>"+"</div>"}function zbscrm_JS_draw_invoice_top_right_form(i){var e,n;return html=(html="")+'<div class="zbs-invoice-topper">'+'<table class="form-table">',"1"!=i.invoiceObj.settings.hideid&&(e="",n=-1,void 0!==i.invoiceObj.id&&(e=i.invoiceObj.id,n=i.invoiceObj.id),html=-1==e?(html+='<tr class="hide"><th></th><td>')+'<input type="hidden" name="zbsinvid" value="'+n+'" /></td></tr>':(html=html+('<tr class="wh-large zbs-invoice-number"><th><label for="no">'+zbscrm_JS_invoice_lang("invoice_number"))+":</label></th><td>")+'<span class="zbs-inv-no">'+e+'</span><input type="hidden" name="zbsinvid" value="'+n+'" /></td></tr>'),html=(html=(html=(html=html+('<tr class="wh-large"><th><label for="date">'+zbscrm_JS_invoice_lang("invoice_date")+":</label></th>")+"<td>")+('<input type="text" name="zbsi_date" id="date" class="form-control zbs-date zbs-empty-start" placeholder="" value="'+i.invoiceObj.date_date+'" data-original-date="'+i.invoiceObj.date_date+'" data-utc="'+i.invoiceObj.date+'" />')+"</td>")+"</tr>"+'<tr class="wh-large">')+('<th><label for="ref">'+zbscrm_JS_invoice_lang("reference")+":</label></th>")+"<td>","reftype"in i.invoiceObj.settings&&"autonumber"===i.invoiceObj.settings.reftype?"draft"===i.invoiceObj.status?(prefix=i.invoiceObj.settings.refprefix,next_number=i.invoiceObj.settings.refnextnum,suffix=i.invoiceObj.settings.refsuffix,is_first_invoice=i.invoiceObj.settings.isfirstinv,html+='<span style="color:grey" title="'+zbscrm_JS_invoice_lang("nextref")+'">'+zbscrm_JS_invoice_lang("autogenerated")+": "+prefix+next_number+suffix+"</span>",is_first_invoice&&""===prefix&&""===suffix&&(html+='<br><a href="'+i.invoiceObj.settings.settings_slug+'"> '+zbscrm_JS_invoice_lang("refsettings")+"</a>")):html+='<span class="zbs-inv-ref">'+i.invoiceObj.id_override+"</span>":html+='<input type="text" name="zbsi_ref" id="ref" class="form-control widetext" placeholder="" value="'+i.invoiceObj.id_override+'" autocomplete="zbsinv" />',html=html+"</td>"+"</tr>",html=void 0!==i.invoiceObj.due_date&&null!=i.invoiceObj.due_date&&0!=i.invoiceObj.due_date?(html=html+('<tr class="wh-large"><th><label for="due_date">'+zbscrm_JS_invoice_lang("due_date"))+":</label></th><td>")+'<input type="text" name="zbsi_due_date" id="due_date" class="form-control zbs-date" placeholder="" value="'+i.invoiceObj.due_date_date+'" data-original-date="'+i.invoiceObj.due_date_date+'" /></td></tr>':(html=(html=(html=(html=(html=(html=(html=(html=(html+='<tr class="wh-large">')+'<th><label for="due">'+zbscrm_JS_invoice_lang("due_date")+':</label></th><td><select id="zbsinv_due_days" name="zbsi_due" class="form-control" style="font-size:16px;">')+'<option value = "-1">'+zbscrm_JS_invoice_lang("due","","none")+"</option>")+'<option value = "0">'+zbscrm_JS_invoice_lang("due","","on")+"</option>")+'<option value = "10">'+zbscrm_JS_invoice_lang("due","","ten")+"</option>")+'<option value = "15">'+zbscrm_JS_invoice_lang("due","","fifteen")+"</option>")+'<option value = "30">'+zbscrm_JS_invoice_lang("due","","thirty")+"</option>")+'<option value = "45">'+zbscrm_JS_invoice_lang("due","","fortyfive")+"</option>")+'<option value = "60">'+zbscrm_JS_invoice_lang("due","","sixty")+"</option>")+'<option value = "90">'+zbscrm_JS_invoice_lang("due","","ninety")+"</option></select></td></tr>","function"==typeof window.zbscrm_JS_draw_invoice_pro_top_right&&(html+=zbscrm_JS_draw_invoice_pro_top_right(i.invoiceObj)),void 0!==window.zbscrmjs_invoice_custom_fields&&window.zbscrmjs_invoice_custom_fields.length,html=html+"</table></div>"+'<div class="clear"></div>'}function zbscrm_JS_draw_send_invoice_to(i){var e=i.invoiceObj.invoice_contact,n=i.invoiceObj.invoice_company,i=("object"==typeof zbs_invoice.invoiceObj.invoice_contact&&void 0!==zbs_invoice.invoiceObj.invoice_contact.id&&(e=parseInt(zbs_invoice.invoiceObj.invoice_contact.id)),"object"==typeof zbs_invoice.invoiceObj.invoice_company&&void 0!==zbs_invoice.invoiceObj.invoice_company.id&&(n=parseInt(zbs_invoice.invoiceObj.invoice_company.id)),i.invoiceObj.bill_name),t=(null!=i&&""!=i||void 0===window.zbsJS_prefillemail||void 0===window.zbsJS_prefillid||(i=window.zbsJS_prefillname,void 0!==window.zbsJS_prefillobjtype&&((e=1==window.zbsJS_prefillobjtype&&-1==e?parseInt(window.zbsJS_prefillid):e)<=0&&(e=-1),(n=2==window.zbsJS_prefillobjtype&&-1==n?parseInt(window.zbsJS_prefillid):n)<=0&&(n=-1))),"");return t+'<div id="billing-to">'+'<div class="billing-to-title">'+('<i class="linkify icon"></i> <span class="your-info-biz">'+zbscrm_JS_invoice_lang("send_to")+"</span>")+"</div>"+'<div class="form-table">'+'<div class="wh-large inv-to-input">'+'<div class="zbs-type-ahead-invoice">'+('<input class="form-control typeahead" type="text" id="zbs_inv_bill" name="zbscq_bill" value="'+i+'" placeholder="'+zbscrm_JS_invoice_lang("bill_to")+'" />')+"</div>"+('<div class="edit-c"><a class="zbs-edit-assign-to" href="#">'+zbscrm_JS_invoice_lang("edit_record")+"</a></div>")+"</div>"+"</div>"+"</div>"+'<div class="clear"></div>'+('<input type="hidden" id="zbs_invoice_contact" name="zbs_invoice_contact" value="'+e+'" />')+('<input type="hidden" id="zbs_invoice_company" name="zbs_invoice_company" value="'+n+'" />')}function zbscrm_JS_draw_customise(i){return html="",html=(html=(html=(html+='<div id="zbs-invoice-customiser">')+'<div class="ui grid" style="margin: 0em 0.5em;">'+'<div class="eight wide column" style="padding:0">')+('<span class="header" style="float:left;">'+zbscrm_JS_invoice_lang("customise")+"</span>"))+'<select class="form-control" id="invoice-customiser-type" name="invoice-customiser-type" id="invoice-customiser-type" style="width:30%;">'+'<option value="quantity"',"quantity"==i.invoiceObj.invoice_hours_or_quantity&&(html+=' selected="selected"'),html=html+(">"+zbscrm_JS_invoice_lang("quantity")+"</option>")+'<option value="hours"',"hours"==i.invoiceObj.invoice_hours_or_quantity&&(html+=' selected="selected"'),html=(html=(html=html+(">"+zbscrm_JS_invoice_lang("hours")+"</option>")+"</select>")+"</div>"+"</div>")+"</div>"+'<div class="clear"></div>'}function zbscrm_JS_draw_invoice_biz_info(i){return html=(html=(html=(html=(html=(html=(html=(html=(html=(html=(html=(html=(html="")+'<div id="zbs-business-info-wrapper">'+'<div class="business-info-toggle">')+('<i class="fa fa-chevron-circle-right" aria-hidden="true"></i> <span class="your-info-biz">'+zbscrm_JS_invoice_lang("biz_info")+"</span>"))+"</div>"+'<div class="business-info">')+'<table class="table zbs-table">'+"<tbody>")+("<tr><td>"+i.invoiceObj.settings.bizname+"</td></tr>"))+("<tr><td>"+i.invoiceObj.settings.yourname+"</td></tr>"))+("<tr><td>"+i.invoiceObj.settings.businessextra+"</td></tr>"))+('<tr class="top-pad"><td>'+i.invoiceObj.settings.businessyouremail+"</td></tr>"))+("<tr><td>"+i.invoiceObj.settings.businessyoururl+"</td></tr>"))+"</tbody>"+"</table>")+('<span class="edit-or-add"><a href="'+i.invoiceObj.settings.biz_settings_slug+'" target="_blank">'+zbscrm_JS_invoice_lang("add_edit")+"</a></span>"))+"</div>"+"</div>"}function zbscrm_JS_draw_line_items(n){window.zbs_invoice_rownum=1;var e,t="";return"function"==typeof window.zbscrm_JS_draw_invoiceCustomiserExtras&&(t=(t+='<div class="clear" style="position:relative;margin:10px;height:40px">')+zbscrm_JS_draw_invoiceCustomiserExtras(n)+"</div>"),t=(t=(t+='<div id="zbs-invoice-items">')+'<table class="table">'+"<thead>")+("<th>"+zbscrm_JS_invoice_lang("description")+"</th>"),t="quantity"==n.invoiceObj.invoice_hours_or_quantity?(t+='<th class="cen" id="zbs_inv_qoh">'+zbscrm_JS_invoice_lang("quantity")+"</th>")+'<th class="cen" id = "zbs_inv_por" >'+zbscrm_JS_invoice_lang("price")+"</th>":(t+='<th class="cen" id="zbs_inv_qoh">'+zbscrm_JS_invoice_lang("hours")+"</th>")+'<th class="cen" id="zbs_inv_por">'+zbscrm_JS_invoice_lang("rate")+"</th>",1==n.invoiceObj.settings.invtax&&(t+='<th class="cen taxhide">'+zbscrm_JS_invoice_lang("tax")+"</th>"),t=(t+="<th>"+zbscrm_JS_invoice_lang("amount")+"</th>")+"</thead>"+'<tbody class="zbs-invoice-line-items">',(rowhtml="")==n.invoiceObj.invoice_items?(e={title:"",desc:"",quantity:i=1,price:0,rate:0},rowhtml+=zbscrm_JS_generate_invoice_row(n,i,e)):jQuery.each(n.invoiceObj.invoice_items,function(i,e){rowhtml+=zbscrm_JS_generate_invoice_row(n,window.zbs_invoice_rownum,e)}),t=(t=(t+=rowhtml)+"</tbody>"+"</table>")+('<div id="zbs-add-new-row"><i class="plus circle icon"></i>'+zbscrm_JS_invoice_lang("add_row")+"</div>")+"</div>"}function zbscrm_JS_draw_invoice_totals(i){var e=(e=(e=(e=(e="")+'<div class="invoice-grand-total-wrapper ui grid">'+'<div class="col-md-6 eight wide column"></div>')+'<div class="col-md-6 inv-totals eight wide column">'+'<div class="total-row">')+('<div class="zlabel half">'+zbscrm_JS_invoice_lang("sub_total")+"</div>"))+'<div class="calc-value half ri" id="subtotal-value"></div>'+"</div>";return 1==i.invoiceObj.settings.invdis&&(e=(e=(e+='<div class="total-row">')+'<div class="zlabel one-four">'+zbscrm_JS_invoice_lang("discount")+"</div>")+'<div class=\'two-four invoice-discount-total\'><input class = "form-control half" type="number" name="invoice_discount_total" id="invoice_discount_total" step="0.01" min="0" value="'+i.invoiceObj.totals.invoice_discount_total+'">',"m"==i.invoiceObj.totals.invoice_discount_type?e+='<select id="invoice_discount_type" name="invoice_discount_type" class="form-control half"><option value="%" >%</option><option value="m" selected>'+zbscrm_JS_invoice_lang("amount")+"</option></select>":e+='<select id="invoice_discount_type" name="invoice_discount_type" class="form-control half"><option value="%">%</option><option value="m">'+zbscrm_JS_invoice_lang("amount")+"</option></select>",e+='</div><div id="discount-value" class = "one-four ri">0</div></div>'),1==i.invoiceObj.settings.invpandp&&(e=(e=(e+='<div class="total-row pbot30">')+'<div class="zlabel half">'+zbscrm_JS_invoice_lang("shipping")+"</div>")+'<input class="zbs_gt zbsli_price-1 half ri topmm5" type="number" step="0.01" min="0" name="invoice_postage_total" id="invoice_postage_total" value="'+i.invoiceObj.totals.invoice_postage_total+'"></div>'),(shipping=i.invoiceObj.totals).taxes=i.invoiceObj.shipping_taxes,1==i.invoiceObj.settings.invpandp&&1==i.invoiceObj.settings.invtax&&(e=(e=(e+='<div class="total-row pbot30">')+'<div class="zlabel half">'+zbscrm_JS_invoice_lang("tax_on_shipping")+"</div>")+'<div class="half ri topmm10">'+zbscrm_JS_output_tax_line(i,-1,shipping)+"</div></div>"),e=(e=(e=(e=(e+='<div class="total-row-wrap" id="tax-total-block">')+"</div>"+'<div class="total-row grand-total">')+('<div class="zlabel half">'+zbscrm_JS_invoice_lang("total")+"</div>")+'<div class="calc-value half ri zbs-heavy" id="zbs-inv-grand-total"></div>')+'<input type="hidden" name="zbs-inv-grand-total-store" id="zbs-inv-grand-total-store" value="0" />'+"</div>")+"</div>"+"</div>"}function zbscrm_JS_draw_partials_table(i){var s=(s='<div id="zbs-invoice-partial-payments" class = "ui grid">')+'<div class="col-md-6 eight wide column"></div>'+'<div class="col-md-6 eight wide column">';return window.invoice_partial=!1,jQuery.each(i.invoiceObj.partials,function(i,e){0==i&&(s+='<div class="partial-row-tab">'+zbscrm_JS_invoice_lang("partial_table")+"</div>"),s+='<div class="partial-row">';var i="",n="",t=(void 0!==e.type&&void 0!==e.type_accounting&&"credit"==e.type_accounting&&(i=" ("+e.type+")"),""),o="",a=(void 0!==e.type_accounting&&"credit"==e.type_accounting&&(t="(",o=")"),e.total),t=t+e.total+o,o=zbscrm_JS_invoice_lang("incomplete","Incomplete"),t=(void 0!==e.status&&(o=e.status),void 0!==e.status_bool&&1!=e.status_bool&&(n+="<br />("+t+" - "+o+")"),zbscrm_JS_transaction_edit_URL(e.id));s=(s+='<div class="zlabel half"><a href="'+t+'" target="_blank">'+e.ref+i+"</a>"+n+"</div>")+'<div class="zbs-partial-value half ri">'+parseFloat(a).toFixed(zbs_root.currencyOptions.noOfDecimals)+"</div></div>",window.invoice_partial=!0}),s=(s=window.invoice_partial?(s+='<div id="amount-due" class="due-row">')+'<div class="amt-due-label zlabel half">'+zbscrm_JS_invoice_lang("amount_due")+'</div><div class="amt-due-amt half ri" id="inv-amount-due"></div></div>':s)+"</div>"+"</div>"}function zbscrm_JS_generate_invoice_row(i,e,n){var t='<tr class="zbs-invoice-row zbs-item-block zbs-rowid'+e+'" data-rowid="'+e+'">';return item_title=null==n.title?"":n.title,item_description=null==n.desc?"":n.desc,t=(t=(t=(t=(t=(t+='<td class="first">')+('<input class="form-control zbs-item-name" type="text" name = "zbsli_itemname[]" value = "'+item_title+'" placeholder="'+zbscrm_JS_invoice_lang("rowtitleplaceholder")+'" /><br/>'))+('<textarea class="form-control" name = "zbsli_itemdes[]" placeholder="'+zbscrm_JS_invoice_lang("rowdescplaceholder")+'">'+item_description+"</textarea>")+"</td>")+'<td class="second">'+('<input type="number" class="zbsli_quan zbsli_quan'+e+' form-control quan" data-zbsr="'+e+'" name = "zbsli_quan[]" value = "'+n.quantity+'" min="0">'))+"</td>"+'<td class="third">')+('<input type="number" class="zbsli_price zbsli_price'+e+' form-controm price" data-zbsr="'+e+'" name = "zbsli_price[]" value = "'+n.price+'" step="0.01">')+"</td>",t=(t=(t=1==i.invoiceObj.settings.invtax?(t+='<td class="forth">')+zbscrm_JS_output_tax_line(i,e,n)+"</td>":t)+('<td class="fifth row-amount row-amount-'+e+'">')+"</td>")+('<td><div class="remove-row" data-rowid="'+e+'"><i class="times circle icon"></i></div></td>')+"</tr>",window.zbs_invoice_rownum++,t}function zbscrm_JS_output_tax_line(i,e,n){var t=void 0===n.taxes||null==n.taxes?0:parseInt(n.taxes);return taxhtml=-1==e?'<select name="zbsli_tax_ship" class="tax-select tax-select'+e+' form-control" data-zbsr="'+e+'">':'<select name="zbsli_tax[]" class="tax-select tax-select'+e+' form-control" data-zbsr="'+e+'">',selected=0==t?"selected":"",taxhtml+='<option value="0" '+selected+">"+zbscrm_JS_invoice_lang("no_tax")+'</option><optgroup label="'+zbscrm_JS_invoice_lang("taxgrouplabel")+'">',jQuery.each(i.tax_linesObj,function(i,e){selected=t==e.id?"selected":"",taxhtml+='<option value="'+e.id+'" '+selected+">"+e.name+" : "+e.rate+"%</option>"}),taxhtml=taxhtml+"</optgroup>"+"</select>"}function zbscrm_JS_add_empty_row(){var i="",e={title:"",desc:"",quantity:1,price:0,rate:0};i+=zbscrm_JS_generate_invoice_row(window.zbs_invoice,window.zbs_invoice_rownum,e),jQuery(".zbs-invoice-line-items").append(i),zbscrm_JS_bind_row_actions()}function zbscrm_JS_bind_due_days(){void 0!==window.zbs_invoice&&void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.due&&jQuery("#zbsinv_due_days").val(window.zbs_invoice.invoiceObj.due)}function zbscrm_JS_bind_row_actions(){jQuery("#zbs-add-new-row").off("click").on("click",function(){zbscrm_JS_add_empty_row(window.zbs_invoice)}),jQuery(".remove-row").off("click").on("click",function(i){var e=jQuery(this).data("rowid");jQuery(".zbs-rowid"+e).remove(),setTimeout(function(){0==jQuery(".zbs-invoice-row").length&&zbscrm_JS_add_empty_row(window.zbs_invoice)},0),zbscrm_JS_calcTotals()}),jQuery(".zbs-item-block input[type=number]").on("keyup mouseup",function(){var i=jQuery(this).data("zbsr");jQuery(this).hasClass("quan")&&(quan=jQuery(this).val()),jQuery(this).hasClass("price")&&(price=jQuery(this).val()),jQuery(this).parent().siblings().find("input[type=number]").each(function(i,e){jQuery(e).hasClass("quan")&&(quan=e.value),jQuery(e).hasClass("price")&&(price=e.value)}),row_tot=quan*price,jQuery(this).parent().siblings(".row-amount-"+i).html(row_tot.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calcTotals()}),jQuery(".tax-select").on("change",function(){jQuery(this).val();zbscrm_JS_calcTotals()})}function zbscrm_JS_calculate_invoice_row_subtotals(){jQuery(".zbs-invoice-row").each(function(i,e){jQuery(e).children().find("input[type=number]").each(function(i,e){zbs_row_to_up=jQuery(this).data("zbsr"),jQuery(this).hasClass("quan")&&(quan=jQuery(this).val()),jQuery(this).hasClass("price")&&(price=jQuery(this).val())}),row_tot=quan*price,jQuery(".row-amount-"+zbs_row_to_up).html(row_tot.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calculate_invoice_subtotal()})}function zbscrm_JS_calculate_invoice_subtotal(){var t=0;jQuery(".row-amount").each(function(i,e){var n=jQuery(this).html();""==n&&(n=0),n=parseFloat(n),t+=n}),jQuery("#subtotal-value").html(t.toFixed(zbs_root.currencyOptions.noOfDecimals))}function zbscrm_JS_calculate_invoice_tax_table(){var o,a,s=[],c=[],l=[];jQuery(".tax-select").each(function(i,e){var n,t;o=jQuery(this).val(),-1==(a=jQuery(this).data("zbsr"))?(s[i]=jQuery(".zbsli_price"+a).val(),l[i]=1):(n=parseFloat(jQuery(".zbsli_quan"+a).val()),t=parseFloat(jQuery(".zbsli_price"+a).val()),s[i]=n*t,l[i]=0),s[i],0<o?(this_tax_line_data=zbscrm_JS_pickTaxRate(o),c[i]=this_tax_line_data.id):c[i]=0}),zbscrm_JS_calculate_tax_amounts(s,c,l)}function zbscrm_JS_pickTaxRate(n){var t=!1;return jQuery.each(window.zbs_invoice.tax_linesObj,function(i,e){void 0!==e.id&&e.id==n&&(t=e)}),t}function zbscrm_JS_calculate_tax_amounts(i,e,n){var t=parseFloat(jQuery("#discount-value").html());if(isNaN(t)&&(t=0),total=parseFloat(jQuery("#subtotal-value").html()),tax_amount=new Array,tax_id=new Array,tax_rate=new Array,0<total){discount_proportion=0<t?t/total:0;for(var o,a=0;a<i.length;a++)discount_proportion=1==n[a]?0:t/total,0<i[a]?0==e[a]?(tax_amount[a]=0,tax_id[a]=0):(o=zbscrm_JS_pickTaxRate(e[a]),o=parseFloat(o.rate),tax_amount[a]=(1-discount_proportion)*i[a]*o/100,tax_id[a]=e[a]):(tax_amount[a]=0,tax_id[a]=e[a])}for(var s=new Object,a=0;a<i.length;a++)s[tax_id[a]]=0;for(a=0;a<i.length;a++)s[tax_id[a]]=s[tax_id[a]]+tax_amount[a];var c="";jQuery.each(s,function(i,e){var n;0<i&&(n=zbscrm_JS_pickTaxRate(i),c=(c=(c=(c+='<div class="total-row row">')+'<div class="tax-name third zlabel">'+n.name+"</div>")+'<div class="tax-rate third ri">('+n.rate+"%)</div>")+'<div class="tax-amt zbs-total-tax third ri">'+s[i].toFixed(zbs_root.currencyOptions.noOfDecimals)+"</div></div>")}),jQuery("#tax-total-block").html(c)}function zbscrm_JS_calc_grandtotal(){var t=0;t+=parseFloat(jQuery("#subtotal-value").html()),1==window.zbs_invoice.invoiceObj.settings.invdis&&(t-=parseFloat(jQuery("#discount-value").html())),1==window.zbs_invoice.invoiceObj.settings.invpandp&&(t+=parseFloat(jQuery("#invoice_postage_total").val())),1==window.zbs_invoice.invoiceObj.settings.invtax&&jQuery(".zbs-total-tax").each(function(i,e){var n=parseFloat(jQuery(this).html());isNaN(n)||(t+=n)}),jQuery("#zbs-inv-grand-total").html(t.toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#zbs-inv-grand-total-store").val(t.toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calc_amount_due()}function zbscrm_JS_calc_amount_due(){window.invoice_partial&&(amount_due=parseFloat(jQuery("#zbs-inv-grand-total").html()),jQuery(".partial-row").each(function(i,e){var e=jQuery(".zbs-partial-value",e).text(),n=1;-1!==e.indexOf("(")&&(e=e.replace("(","").replace(")",""),n=-1),e=parseFloat(e)*n,amount_due-=e}),jQuery("#inv-amount-due").html(amount_due.toFixed(zbs_root.currencyOptions.noOfDecimals)))}function zbscrm_JS_bind_change_actions(){jQuery("#invoice-customiser-type").on("change",function(){"hours"==jQuery(this).val()?(jQuery("#zbs_inv_qoh").html("Hours"),jQuery("#zbs_inv_por").html("Rate")):(jQuery("#zbs_inv_qoh").html("Quantity"),jQuery("#zbs_inv_por").html("Price"))}),jQuery("#invoice_postage_total").on("change",function(){jQuery("#pandptotal").html(window.zbs_root.currencyOptions.currencyStr+parseFloat(jQuery(this).val()).toFixed(zbs_root.currencyOptions.noOfDecimals)),zbscrm_JS_calcTotals()}),jQuery("#invoice_discount_total, #invoice_discount_type").on("change",function(){zbscrm_JS_calcTotals()}),jQuery("#invoice_postage_tax").on("keyup mouseup",function(){""!=jQuery(this).val()&&zbscrm_JS_calcTotals()})}function zbscrm_JS_calculatediscount(){var i=jQuery("#invoice_discount_total").val(),e=jQuery("#invoice_discount_type").val();""!=i&&("m"==e?(jQuery("#invoice_discount_total_value").val(parseFloat(i).toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#discount-value").html(parseFloat(i).toFixed(zbs_root.currencyOptions.noOfDecimals))):(e=parseFloat(jQuery("#subtotal-value").html())*i/100,jQuery("#invoice_discount_total_value").val(parseFloat(e).toFixed(zbs_root.currencyOptions.noOfDecimals)),jQuery("#discount-value").html(parseFloat(e).toFixed(zbs_root.currencyOptions.noOfDecimals))))}function zbscrm_JS_invoice_typeahead_bind(){endpoint=wpApiSettings.root+"zbscrm/v1/concom?_wpnonce="+wpApiSettings.nonce;var n=new Bloodhound({datumTokenizer:function(i){return Bloodhound.tokenizers.whitespace(i.name_email)},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:endpoint,ttl:3e5,ajax:{type:"POST",cache:!1,data:{id:-1,obj_type:-1},complete:function(i,e){n.clearRemoteCache()}}},remote:{url:wpApiSettings.root+"zbscrm/v1/concom?_wpnonce="+wpApiSettings.nonce+"&s=%QUERY",wildcard:"%QUERY"}});n.initialize(),jQuery("#billing-to .typeahead").typeahead({minLength:1,highlight:!0,hint:!0},{name:"customers_and_companies",displayKey:"name_email",display:function(i){return i.name.trim()?i.name:i.email||"Contact #"+i.id},source:n.ttAdapter(),limit:10,templates:{suggestion:function(i){ico=2==i.obj_type?'<i class="building icon"></i>':'<i class="user icon"></i>';var e=i.name.trim()?i.name:zeroBSCRMJS_globViewLang("contact")+" #"+i.id,i=i.email||"<i>"+zbscrm_JS_invoice_lang("noemail")+"</i>";return sug='<div class="sug-wrap"><div class="ico">'+ico+'</div><div class="inner"><div class="name">'+e+'</div><div class="email">'+i+'</div></div><div class="clear"</div></div>'},empty:function(i){var e='<a href="'+window.zbs_invoice.invoiceObj.settings.addnewcontacturl+'" target="_blank">'+zbscrm_JS_invoice_lang("addnewcontact")+"</a>";return'<div class="zbs-add-new-js-assign-to"><i class="address book icon"></i>  '+(e=window.zbs_invoice.invoiceObj.settings.b2bmode?(e+=" "+zbscrm_JS_invoice_lang("or")+" ")+'<a href="'+window.zbs_invoice.invoiceObj.settings.addnewcompanyurl+'" target="_blank">'+zbscrm_JS_invoice_lang("newcompany")+"</a>":e)+"</div>"}}}).on("typeahead:selected",function(i,e,n){var t;jQuery("#zbs_invoicing_send_email").hide(),void 0!==e.id&&null!==e.id&&""!==e.id&&void 0!==(t=zbscrmJS_retrieveCurrentBillToEmail())&&""!=t&&zbscrm_JS_validateEmail(t)&&jQuery("#zbs_invoicing_send_email").show(),1==e.obj_type?(jQuery("#zbs_invoice_contact").val(e.id),jQuery("#zbs_invoice_company").val(-1),zeroBSCRMJS_showContactLinkIf(e.id),zeroBSCRMJS_showCompanyLinkIf(-1)):2==e.obj_type&&(jQuery("#zbs_invoice_company").val(e.id),jQuery("#zbs_invoice_contact").val(-1),zeroBSCRMJS_showContactLinkIf(-1),zeroBSCRMJS_showCompanyLinkIf(e.id))}).on("typeahead:change",function(i,e,n){jQuery("#zbs_invoicing_send_email").hide(),void 0!==e.id&&null!==e.id&&""!==e.id?void 0!==(e=zbscrmJS_retrieveCurrentBillToEmail())&&""!=e&&zbscrm_JS_validateEmail(e)&&jQuery("#zbs_invoicing_send_email").show():""==jQuery("#zbs_inv_bill").val()&&(jQuery("#zbs_invoice_contact").val(-1),jQuery("#zbs_invoice_company").val(-1),zeroBSCRMJS_showContactLinkIf(-1),zeroBSCRMJS_showCompanyLinkIf(-1))}),setTimeout(function(){var i=(new Date).getTime(),e=jQuery("#billing-to .typeahead").attr("data-autokey"),i="zbsobj-"+i+"-"+(e=void 0===e?"-typeahead":e);jQuery("#billing-to .typeahead").attr("autocomplete",i).attr("name",i)},0),jQuery(this).on("typeahead:open",function(i,e){var n=(new Date).getTime(),t=jQuery("#billing-to .typeahead").attr("data-autokey"),n="zbsobj-"+n+"-"+(t=void 0===t?"-typeahead":t);jQuery("#billing-to .typeahead").attr("autocomplete",n).attr("name",n)})}function zbscrm_JS_bindInitialLearnLinks(){var i;void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.invoice_contact&&"0"!=window.zbs_invoice.invoiceObj.invoice_contact&&"-1"!=window.zbs_invoice.invoiceObj.invoice_contact&&0<(i=parseInt(window.zbs_invoice.invoiceObj.invoice_contact))&&zeroBSCRMJS_showContactLinkIf(i),void 0!==window.zbs_invoice.invoiceObj&&void 0!==window.zbs_invoice.invoiceObj.invoice_company&&"0"!=window.zbs_invoice.invoiceObj.invoice_company&&"-1"!=window.zbs_invoice.invoiceObj.invoice_company&&0<(i=parseInt(window.zbs_invoice.invoiceObj.invoice_company))&&zeroBSCRMJS_showCompanyLinkIf(i)}function zeroBSCRMJS_showContactLinkIf(i){jQuery("#zbs-invoice-learn-nav .zbs-invoice-quicknav-contact").remove(),null!=i&&""!==i&&0<(i=parseInt(i))&&(i='<a target="_blank" style="margin-left:6px;" class="zbs-invoice-quicknav-contact ui icon button blue mini labeled" href="'+window.zbs_invoice.invoiceObj.settings.contacturlprefix+i+'"><i class="user icon"></i> '+zbscrm_JS_invoice_lang("contact")+"</a>",jQuery("#zbs-invoice-learn-nav").prepend(i))}function zeroBSCRMJS_showCompanyLinkIf(i){jQuery("#zbs-invoice-learn-nav .zbs-invoice-quicknav-company").remove(),null!=i&&""!==i&&0<(i=parseInt(i))&&(i='<a target="_blank" style="margin-left:6px;" class="zbs-invoice-quicknav-company ui icon button blue mini labeled" href="'+window.zbs_invoice.invoiceObj.settings.companyurlprefix+i+'"><i class="building icon"></i> '+zbscrm_JS_invoice_lang("company")+"</a>",jQuery("#zbs-invoice-learn-nav").prepend(i))}function zbscrm_JS_bind_invoice_actions(){jQuery(".zbs-add-memo-trigger").off("click").on("click",function(i){jQuery(".zbs-memo-box").show(),jQuery(".zbs-add-memo-trigger").hide()}),jQuery(".zbs-memo-hide").off("click").on("click",function(i){jQuery(".zbs-memo-box").hide(),jQuery(".zbs-add-memo-trigger").show()}),jQuery(".wh-logo-set .zbs-remove").off("click").on("click",function(i){jQuery("#wh-logo-set-img").attr("src","").hide(),jQuery("#zbs_invoice_logo").val(""),jQuery(".wh-logo").removeClass("hide").show(),jQuery(".wh-logo-set").hide()}),jQuery(".business-info-toggle").off("click").on("click",function(i){i.preventDefault(),jQuery(".business-info-toggle i").hasClass("fa-chevron-circle-right")?(jQuery(".business-info-toggle i").removeClass("fa-chevron-circle-right").addClass("fa-chevron-circle-down"),jQuery(".business-info").show()):(jQuery(".business-info-toggle i").removeClass("fa-chevron-circle-down").addClass("fa-chevron-circle-right"),jQuery(".business-info").hide())}),jQuery(".wh-logo, .wh-logo-set .zbs-update").off("click").on("click",function(i){var e;i.preventDefault(),formlabel=jQuery(this).parent(),e||(e=wp.media.frames.zbs_media_frame=wp.media({className:"media-frame zbs-media-frame",frame:"select",multiple:!1,library:{type:"image"}})).on("select",function(){var i=e.state().get("selection").first().toJSON();jQuery("#logo").val(i.url),jQuery("#wh-logo-set-img").attr("src",i.url).show(),jQuery(".wh-logo-set").show(),jQuery(".wh-logo").hide()}),e.open()}),jQuery("#zbs_invoicing_download_pdf").off("click").on("click",function(i){i.preventDefault(),jQuery("#zbs_invoicing_download_pdf_form").submit()}),zbscrm_JS_bind_due_days(),zbscrm_JS_bindDateRangePicker(),zbscrm_JS_invoice_typeahead_bind(),zbscrm_JS_bindInitialLearnLinks(),zbscrm_JS_calculate_invoice_row_subtotals(),zbscrm_JS_calcTotals(),jQuery("#zbs_invoicing_send_email").off("click").on("click",function(i,e){zbscrmJS_sendInvoiceModal()})}function zbscrmJS_sendInvoiceModal(){var i,e="",n=zbscrmJS_retrieveCurrentBillToEmail();void 0!==(e=void 0!==n&&""!=n&&zbscrm_JS_validateEmail(n)?n:e)&&""!=e&&zbscrm_JS_validateEmail(e)?(n='<div id="zbs_invoice_email_modal_opts">',n=(n=(n+='<div class="zbs-invoice-email-modal-field">')+'<label for="zbs_invoice_email_modal_toemail">'+zbscrm_JS_invoice_lang("toemail")+"</label>")+'<input type="email" id="zbs_invoice_email_modal_toemail" value="'+e+'" placeholder="'+zbscrm_JS_invoice_lang("toemailplaceholder")+'" /></div>',0<jQuery(".zbsFileLine").length&&(i="",n=(n=(n+='<div class="zbs-invoice-email-modal-field">')+'<input type="checkbox" id="zbs_invoice_email_modal_attachassoc" value="1" '+(i=jQuery("#zbsc_sendattachments").is(":checked")?'checked="checked" ':i)+"/>")+'<label for="zbs_invoice_email_modal_attachassoc">'+zbscrm_JS_invoice_lang("attachassoc")+"</label></div>"),n=(n=n+'<div class="zbs-invoice-email-modal-field"><input type="checkbox" id="zbs_invoice_email_modal_attachaspdf" value="1" '+(i='checked="checked" ')+"/>")+'<label for="zbs_invoice_email_modal_attachaspdf">'+zbscrm_JS_invoice_lang("attachpdf")+"</label></div></div>",swal({title:zbscrm_JS_invoice_lang("send_email"),html:'<div class="ui segment">'+zbscrm_JS_invoice_lang("sendthisemail")+n+"</div>",type:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:zbscrm_JS_invoice_lang("sendthemail")}).then(function(i){var e,n;i.value&&(void 0!==(i=jQuery("#zbs_invoice_email_modal_toemail").val())&&""!=i&&zbscrm_JS_validateEmail(i)&&0<window.invoice_id?(e=-1,0<jQuery("#zbs_invoice_email_modal_attachassoc").length&&jQuery("#zbs_invoice_email_modal_attachassoc").is(":checked")&&(e=1),n=-1,0<jQuery("#zbs_invoice_email_modal_attachaspdf").length&&jQuery("#zbs_invoice_email_modal_attachaspdf").is(":checked")&&(n=1),i={id:window.invoice_id,email:i,attachassoc:e,attachpdf:n},swal.fire({title:zbscrm_JS_invoice_lang("sendingemail"),html:'<div style="clear:both">&nbsp;</div><div class="ui active loader" style="margin-top:2em;padding-bottom:2em"></div><div style="clear:both">&nbsp;</div>',showConfirmButton:!1,showCancelButton:!1,allowOutsideClick:!1}),zbscrmJS_sendInvoiceEmail(i)):swal.fire(zbscrm_JS_invoice_lang("sendneedsassignment")))})):swal.fire(zbscrm_JS_invoice_lang("sendneedsassignment"))}function zbscrmJS_sendInvoiceEmail(i){window.zbsInvBlocker||(window.zbsInvBlocker=!0,void 0!==i.id&&0<i.id&&void 0!==i.email&&zbscrm_JS_validateEmail(i.email)&&(i.action="zbs_invoice_send_invoice",i.security=jQuery("#inv-ajax-nonce").val(),jQuery.ajax({url:ajaxurl,type:"POST",data:i,dataType:"json",success:function(i){swal(zbscrm_JS_invoice_lang("senttitle"),zbscrm_JS_invoice_lang("sent"),"info"),window.zbsInvBlocker=!1},error:function(i){console.error("senderr",i),swal(zbscrm_JS_invoice_lang("senderrortitle")+" #19v3",zbscrm_JS_invoice_lang("senderror"),"error"),window.zbsInvBlocker=!1}})))}function zbscrm_JS_transaction_edit_URL(i){return 2<zbscrm_JS_DAL()?zeroBSCRMJS_obj_editLink("transaction",i):(zbs_admin_url=window.zbs_links.admin_url,zbs_transaction_link=zbs_admin_url+"post.php?action=edit&post="+i)}function zeroBSCRMJS_invEditLang(i){return void 0!==window.zbsInvoiceBuilderLang[i]?window.zbsInvoiceBuilderLang[i]:""}function zbscrm_JS_calcTotals(){zbscrm_JS_calculate_invoice_subtotal(),zbscrm_JS_calculatediscount(),zbscrm_JS_calculate_invoice_tax_table(),zbscrm_JS_calc_grandtotal()}function zbscrm_JS_invoice_lang(i,e,n){if(void 0===e&&(e=""),void 0!==window.zbs_invoice.invoiceObj.settings.lang[i]){if(void 0===n)return window.zbs_invoice.invoiceObj.settings.lang[i];if(void 0!==window.zbs_invoice.invoiceObj.settings.lang[i][n])return window.zbs_invoice.invoiceObj.settings.lang[i][n]}return e}jQuery(function(){jQuery(".handlediv").remove(),jQuery(".ui-sortable-handle").remove(),jQuery(".hndle").css("cursor","default"),zbscrm_JS_retrieve_invoice_data(invoice_id=jQuery(".zbs_invoice_html_canvas").data("invid")),0<jQuery("#invoice_tax_total").val()&&jQuery("#invoice_totals .tax_total").show()});